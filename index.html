<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini GeoGuessr Streets — Jeu complet (1 fichier)</title>

<!-- Leaflet (mini carte) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""></script>

<style>
:root{
  --bg:#071228; 
  --card:#071826; 
  --accent:#06b6d4; 
  --glass: rgba(255,255,255,0.04);
  --text:#e6eef6; 
  --muted:#9fb0c8;
}

*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:linear-gradient(180deg,#031022,#071228); color:var(--text)}
#app {height:100vh; display:grid; grid-template-columns: 1fr 380px; gap:0}

/* Left: Street View iframe */
#left {position:relative; overflow:hidden; background:#000;}
iframe#sv { width:100%; height:100%; border:0; display:block; transition:opacity .35s ease-in-out; }

/* Right: controls & mini-map */
#right {padding:16px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-left:1px solid rgba(255,255,255,0.03); display:flex; flex-direction:column; gap:12px;}
.card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02)}
h1{margin:0 0 6px 0; font-size:18px}
label{font-size:13px; color:var(--muted)}

/* Inputs, selects, buttons */
select,input,button{
  width:100%; 
  padding:8px 10px; 
  margin-top:6px; 
  border-radius:10px; 
  border:1px solid rgba(255,255,255,0.04); 
  background:var(--glass); 
  color:var(--text); 
  font-size:14px;
}

/* Dark style for select dropdown options */
select {
  background-color: #000;      /* fond noir */
  color: #fff;                 /* texte blanc */
  border: 1px solid rgba(255,255,255,0.1);
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding-right: 24px;
  cursor: pointer;
}
select option {
  background-color: #000;  /* fond noir options */
  color: #fff;             /* texte blanc options */
}

/* Rows for buttons */
.row {display:flex; gap:8px}
.row > * {flex:1}

/* Buttons */
button {cursor:pointer; border:none}
button.primary {background:linear-gradient(90deg,var(--accent),#22c1c1); color:#022; font-weight:700; transition:transform .15s ease}
button.primary:active{transform:scale(.98)}
button.ghost {background:transparent; border:1px solid rgba(255,255,255,0.06)}
.small {font-size:13px; padding:6px 8px; border-radius:8px}

/* Info */
.stat {display:flex; justify-content:space-between; align-items:center; font-size:14px; margin-top:6px}
.stat .big {font-size:20px; font-weight:700}

/* mini-map container */
#map {height:320px; border-radius:10px; overflow:hidden; margin-top:8px; border:1px solid rgba(255,255,255,0.03)}
footer {margin-top:auto; font-size:12px; color:var(--muted)}

/* overlay on left for round info */
#overlay {
  position:absolute; left:12px; top:12px; z-index:20; 
  background:linear-gradient(180deg, rgba(2,6,23,0.65), rgba(2,6,23,0.55));
  color:var(--text); padding:12px 14px; border-radius:12px; backdrop-filter: blur(6px);
  box-shadow:0 12px 30px rgba(0,0,0,0.6); min-width:240px; border:1px solid rgba(255,255,255,0.02)
}
.muted {color:var(--muted); font-size:13px}
.controls-inline {display:flex; gap:8px; margin-top:8px}
.divider {height:1px; background:rgba(255,255,255,0.03); margin:8px 0; border-radius:2px}

/* subtle animations */
.fade-in {animation: fadeIn .35s ease both}
@keyframes fadeIn { from {opacity:0; transform:translateY(6px)} to {opacity:1; transform:none} }

/* highlight for new best */
.best-badge {display:inline-block; padding:6px 8px; background:linear-gradient(90deg,#ffd166,#ffc107); color:#062023; border-radius:8px; font-weight:700; margin-top:8px}

/* responsive */
@media (max-width:1000px){
  #app{grid-template-columns: 1fr;}
  #right{position:relative; height:420px}
}
</style>


</head>
<body>
<div id="app">
  <div id="left">
    <iframe id="sv" allowfullscreen sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>

    <div id="overlay" class="card fade-in">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div>
          <div class="muted">Manche</div>
          <div class="big" id="roundInfo">0 / 0</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Score</div>
          <div class="big" id="scoreInfo">0</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="muted">Temps restant</div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px">
        <div style="font-weight:700; font-size:18px" id="timer">60</div>
        <div style="width:100%">
          <div class="controls-inline">
            <button id="pauseBtn" class="small ghost">Pause</button>
            <button id="nextBtnTop" class="small primary">Nouvelle position</button>
          </div>
        </div>
      </div>

      <div style="margin-top:8px">
        <div class="muted">Mode</div>
        <select id="modeSelect">
          <option value="city">Ville sélectionnée</option>
          <option value="france">France entière</option>
          <option value="europe">Europe</option>
        </select>

        <div class="muted" style="margin-top:8px">Choisir une ville</div>
        <select id="city-select">
  <option value="paris">Paris</option>
  <option value="strasbourg">Strasbourg</option>
  <option value="reichshoffen">Reichshoffen</option>
  <option value="lunel">Lunel</option>
  <option value="haguenau">Haguenau</option>
</select>


        <div class="divider"></div>

        <div class="muted">Réglages</div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <input id="roundsInput" type="number" min="1" max="12" value="5" title="Manches">
          <input id="timerInput" type="number" min="10" max="300" value="60" title="Secondes">
        </div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button id="startBtn" class="primary">Démarrer</button>
          <button id="replayBtn" class="ghost">Rejouer</button>
        </div>
      </div>
    </div>
  </div>

  <div id="right">
    <div class="card fade-in">
      <h1>Mini GeoGuessr Streets</h1>
      <div class="muted">Clique sur la mini-carte pour placer ton estimation, puis valide.</div>

      <div style="margin-top:8px">
        <div class="row">
          <button id="placeGuessBtn" class="primary small">Placer estimation</button>
          <button id="confirmBtn" class="ghost small">Valider</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="skipBtn" class="ghost small">Passer</button>
          <button id="revealBtn" class="ghost small">Montrer réel</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="stat"><div>Distance :</div><div id="distanceInfo">—</div></div>
      <div class="stat"><div>Points cette manche :</div><div id="roundScore">—</div></div>

      <div class="divider"></div>

      <div class="muted">Mini-carte cliquable</div>
      <div id="map"></div>
    </div>

    <div class="card fade-in" style="margin-top:10px">
      <h1>Informations & meilleurs</h1>
      <div class="muted">Règles rapides</div>
      <ul style="margin-top:8px; padding-left:18px">
        <li>Manches par défaut : 5 (modifiables)</li>
        <li>Score par manche : 0–5000 (formule améliorée)</li>
        <li>Le jeu utilise uniquement des emplacements sur des rues fournis</li>
      </ul>
      <div class="divider"></div>
      <div class="muted">Meilleur score (local)</div>
      <div id="bestBox" style="margin-top:8px"></div>

      <div class="divider"></div>
      <div id="finalBox"></div>
    </div>

    <footer style="margin-top:auto">Développé — Mini GeoGuessr (sans API). Mini-carte : OpenStreetMap / Leaflet.</footer>
  </div>
</div>

<script>
/* -------------------------
   Points (uniquement rues) - conservés et sûrs
   ------------------------- */
/* -------------------------
   Points (uniquement rues) - conservés et sûrs
   ------------------------- */
const cityPoints = {
    paris: [
    {lat:48.854687, lng:2.317843},  // Invalides
    {lat:48.895226, lng:2.373407},  // 19e Arrondissement
    {lat:48.822227, lng:2.352474},  // Quartier des peupliers
    {lat:48.853412, lng:2.409172},  // Charonne
    {lat:48.850246, lng:2.303589},  // École Militaire
    {lat:48.875130, lng:2.289080},  // Chaillot
    {lat:48.852469, lng:2.321304},  // 7e Arrondissement
    {lat:48.895067, lng:2.346205},  // 84-98 Rue Duhesme
    {lat:48.902938, lng:2.323760},  // 59 Rue Arago, Saint-Ouen-sur-Seine
    {lat:48.904828, lng:2.373799}   // Av. Victor Hugo, Aubervilliers
  ],
  strasbourg: [
    {lat:48.5833, lng:7.75},
    {lat:48.582325, lng:7.750871},
    {lat:48.5815, lng:7.7502},
    {lat:48.5810, lng:7.7520},
    {lat:48.58056, lng:7.75190},
    {lat:48.58105, lng:7.74029},
    {lat:48.581, lng:7.75144},
    {lat:48.589036, lng:7.769948},
    {lat:48.57928, lng:7.748565},
    {lat:48.58612, lng:7.75189},
    {lat:48.58069, lng:7.74072},
    {lat:48.578689, lng:7.749437},
    {lat:48.5817, lng:7.750555},
    {lat:48.582932, lng:7.74375},
    {lat:48.585, lng:7.75}
  ],
  reichshoffen: [
    {lat:48.932, lng:7.666},
    {lat:48.931874, lng:7.664453},
    {lat:48.932024, lng:7.664349},
    {lat:48.930865, lng:7.657916},
    {lat:48.93048, lng:7.66608},
    {lat:48.950187, lng:7.677909},
    {lat:48.9383, lng:7.6737}
  ],
   lunel: [
    {lat:43.682162, lng:4.127511},  // 542-382 Av. Louis Abric
    {lat:43.668834, lng:4.126547},  // 104 Rue de la Bouvine
    {lat:43.674131, lng:4.143396},  // 430-314 D34
    {lat:43.684638, lng:4.137527},  // 1-147 Rue Thomas Millerot
    {lat:43.689321, lng:4.127474},  // 292-220 Rue Alexandre Dumas
    {lat:43.678144, lng:4.115355},  // 104 Rue des Fournels
    {lat:43.675097, lng:4.122626}   // 366-522 Chem. du Jeu de Mail
  ]
};

/* Europe sample points */
const europePoints = [
  {lat:51.507350, lng:-0.127758}, {lat:52.520008, lng:13.404954},
  {lat:52.370216, lng:4.895168}, {lat:40.416775, lng:-3.703790},
  {lat:41.902782, lng:12.496366}, {lat:38.722252, lng:-9.139337},
  {lat:50.850346, lng:4.351721}
];

/* Utilitaires */
function randInt(n){ return Math.floor(Math.random()*n) }
function choice(arr){ return arr[randInt(arr.length)] }

/* Haversine distance (km) */
function haversineKm(lat1, lon1, lat2, lon2){
  function toRad(d){ return d * Math.PI/180 }
  const R = 6371;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1)
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))
  return R * c
}

/* Score function améliorée
   - donne grosso modo 5000 pour proches, décroissance log pour distances élevées
   - garde 0..5000 range
*/
function scoreFromDistanceKm(dKm){
  if(isNaN(dKm)) return 0;
  if(dKm <= 0.02) return 5000; // très proche (<20m)
  // on utilise une échelle logarithmique douce
  const maxEffective = 20000; // km
  const v = Math.log10(1 + dKm) / Math.log10(1 + maxEffective); // 0..1
  const score = Math.round(5000 * (1 - v));
  return Math.max(0, Math.min(5000, score));
}

/* -------------------------
   Etat du jeu
   ------------------------- */
let current = { lat:null, lng:null, cityKey:null, mode:'city' };
let map, guessMarker = null, actualMarker = null, line = null;
let placing = false, guessLatLng = null;
let roundsTotal = 5, roundIndex = 0, timerSeconds = 60, timerId = null, timerRunning = false;
let totalScore = 0;

/* ---------- Leaflet init ---------- */
function initMap(){
  map = L.map('map', {attributionControl:false}).setView([48.8566,2.3522], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  map.on('click', function(e){
    if(!placing) return;
    placeGuessMarker(e.latlng);
  });
}

/* Place guess marker */
function placeGuessMarker(latlng){
  guessLatLng = latlng;
  if(guessMarker) guessMarker.setLatLng(latlng);
  else {
    guessMarker = L.marker(latlng, {draggable:true}).addTo(map);
    guessMarker.on('dragend', e => { guessLatLng = e.target.getLatLng() });
  }
}

/* Fit map to both points */
function fitMapToBoth(aLatLng){
  const group = [];
  if(guessLatLng) group.push([guessLatLng.lat, guessLatLng.lng]);
  if(aLatLng) group.push([aLatLng.lat, aLatLng.lng]);
  if(group.length>0) map.fitBounds(group, {padding:[30,30], maxZoom:14});
}

/* Cleanup */
function clearRoundDraw(){
  if(guessMarker){ map.removeLayer(guessMarker); guessMarker = null; guessLatLng = null; }
  if(actualMarker){ map.removeLayer(actualMarker); actualMarker = null; }
  if(line){ map.removeLayer(line); line = null; }
}

/* -------------------------
   Street View iframe
   ------------------------- */
function setStreetView(lat,lng){
  const iframe = document.getElementById('sv');
  // crossfade for smoother UX
  iframe.style.opacity = '0';
  setTimeout(()=>{
    iframe.src = `https://www.google.com/maps?q&layer=c&cbll=${lat},${lng}&cbp=12,0,0,0,0&output=svembed`;
    iframe.style.opacity = '1';
  }, 260);
}

/* -------------------------
   Game flow
   ------------------------- */
function resetGame(){
  roundIndex = 0; totalScore = 0;
  document.getElementById('scoreInfo').textContent = totalScore;
  document.getElementById('finalBox').innerHTML = '';
  clearRoundDraw();
  stopTimer();
  updateRoundUI();
}

function startGame(){
  roundsTotal = parseInt(document.getElementById('roundsInput').value) || 5;
  timerSeconds = parseInt(document.getElementById('timerInput').value) || 60;
  document.getElementById('roundScore').textContent = '—';
  resetGame();
  nextRound();
}

function nextRound(){
  clearRoundDraw();
  guessLatLng = null;
  placing = true;
  document.getElementById('distanceInfo').textContent = '—';
  document.getElementById('roundScore').textContent = '—';
  document.getElementById('confirmBtn').disabled = false;
  document.getElementById('placeGuessBtn').disabled = false;
  document.getElementById('revealBtn').disabled = false;
  document.getElementById('skipBtn').disabled = false;

  roundIndex++;
  updateRoundUI();

  const mode = document.getElementById('modeSelect').value;
  current.mode = mode;
  if(mode === 'city'){
    const cityKey = document.getElementById('city-select').value;
    current.cityKey = cityKey;
    const p = choice(cityPoints[cityKey]);
    current.lat = p.lat; current.lng = p.lng;
  } else if(mode === 'france'){
    const cityKey = choice(Object.keys(cityPoints));
    current.cityKey = cityKey;
    const p = choice(cityPoints[cityKey]);
    current.lat = p.lat; current.lng = p.lng;
  } else if(mode === 'europe'){
    const p = choice(europePoints);
    current.cityKey = 'europe';
    current.lat = p.lat; current.lng = p.lng;
  }

  setStreetView(current.lat, current.lng);
  map.setView([current.lat, current.lng], (current.mode === 'europe' ? 6 : 13));
  startTimer(timerSeconds);
  document.getElementById('finalBox').innerHTML = '';
}

/* Submit guess */
function submitGuess(auto=false){
  if(!placing) return;
  placing = false;
  stopTimer();
  document.getElementById('confirmBtn').disabled = true;
  document.getElementById('placeGuessBtn').disabled = true;

  if(!guessLatLng){
    document.getElementById('distanceInfo').textContent = 'Aucune estimation — 0 pts';
    document.getElementById('roundScore').textContent = '0';
    updateScoreAndProceed(0, null);
    return;
  }

  const dKm = haversineKm(current.lat, current.lng, guessLatLng.lat, guessLatLng.lng);
  const pts = scoreFromDistanceKm(dKm);
  document.getElementById('distanceInfo').textContent = dKm.toFixed(2) + ' km';
  document.getElementById('roundScore').textContent = pts;

  // Affiche l'emplacement réel et la ligne
  actualMarker = L.marker([current.lat, current.lng], {opacity:0.95}).addTo(map);
  line = L.polyline([[guessLatLng.lat, guessLatLng.lng],[current.lat, current.lng]], {color:'#22c1c1', weight:4, opacity:0.9}).addTo(map);
  fitMapToBoth({lat:current.lat, lng:current.lng});

  // Met à jour le score mais attend avant le round suivant
  totalScore += pts;
  document.getElementById('scoreInfo').textContent = totalScore;

  if(roundIndex >= roundsTotal){
    // fin du jeu après un délai
    setTimeout(()=> endGame(), 2500); // 2.5s pour voir l'emplacement
  } else {
    // passe au round suivant après délai
    setTimeout(()=> nextRound(), 2500); // 2.5s pour voir l'emplacement
  }
}


/* Skip */
function skipRound(){
  placing = false;
  stopTimer();
  clearRoundDraw();
  document.getElementById('distanceInfo').textContent = 'Passée — 0 pts';
  document.getElementById('roundScore').textContent = '0';
  updateScoreAndProceed(0, null);
}

/* Reveal actual without scoring change */
function revealActual(){
  if(actualMarker) return;
  actualMarker = L.marker([current.lat, current.lng]).addTo(map);
  map.setView([current.lat, current.lng], 14);
}

/* After scoring */
function updateScoreAndProceed(pts, dKm){
  totalScore += pts;
  document.getElementById('scoreInfo').textContent = totalScore;

  // save best if end and higher
  if(roundIndex >= roundsTotal){
    // small delay to show line, then end
    setTimeout(()=> endGame(), 900);
  } else {
    setTimeout(()=> nextRound(), 900);
  }
}

/* End game + localStorage best */
function endGame(){
  placing = false; stopTimer();
  document.getElementById('finalBox').innerHTML = `<div style="font-weight:700; font-size:16px">Partie terminée — Score final : ${totalScore}</div>
    <div style="margin-top:8px">Vous pouvez rejouer ou changer les paramètres.</div>`;

  saveBest(totalScore);
  showBest();
}

/* -------------------------
   Timer
   ------------------------- */
function startTimer(seconds){
  stopTimer();
  let t = seconds;
  document.getElementById('timer').textContent = t;
  timerRunning = true;
  timerId = setInterval(()=>{
    t--;
    document.getElementById('timer').textContent = t;
    if(t <= 0){
      clearInterval(timerId);
      timerRunning = false;
      submitGuess(true);
    }
  }, 1000);
}

function stopTimer(){
  if(timerId) clearInterval(timerId);
  timerId = null;
  timerRunning = false;
}

/* -------------------------
   UI & events
   ------------------------- */
document.getElementById('startBtn').addEventListener('click', ()=> startGame());
document.getElementById('replayBtn').addEventListener('click', ()=> { resetGame(); showBest(); });
document.getElementById('nextBtnTop').addEventListener('click', ()=> {
  if(roundIndex >= roundsTotal){ resetGame(); startGame(); return; }
  nextRound();
});
document.getElementById('placeGuessBtn').addEventListener('click', ()=> {
  placing = true;
  document.getElementById('finalBox').innerHTML = '<div class="muted">Clique sur la mini-carte pour placer ton estimation ou déplace le marqueur.</div>';
});
document.getElementById('confirmBtn').addEventListener('click', ()=> submitGuess(false));
document.getElementById('skipBtn').addEventListener('click', ()=> skipRound());
document.getElementById('revealBtn').addEventListener('click', ()=> revealActual());
document.getElementById('pauseBtn').addEventListener('click', ()=>{
  if(timerRunning){ stopTimer(); document.getElementById('pauseBtn').textContent = 'Reprendre'; }
  else { startTimer(parseInt(document.getElementById('timer').textContent)||timerSeconds); document.getElementById('pauseBtn').textContent = 'Pause'; }
});

function updateRoundUI(){
  document.getElementById('roundInfo').textContent = `${Math.min(roundIndex+1, roundsTotal)} / ${roundsTotal}`;
  document.getElementById('timer').textContent = timerSeconds;
  document.getElementById('distanceInfo').textContent = '—';
  document.getElementById('roundScore').textContent = '—';
}

/* -------------------------
   localStorage best scores
   ------------------------- */
const BEST_KEY = 'mini_geo_best_score_v1';
function saveBest(score){
  const prev = parseInt(localStorage.getItem(BEST_KEY) || '0', 10);
  if(score > prev){
    localStorage.setItem(BEST_KEY, String(score));
    // small celebration
    const bestBox = document.getElementById('bestBox');
    bestBox.innerHTML = `<div class="best-badge">Nouveau meilleur : ${score}</div>`;
  }
}
function showBest(){
  const best = parseInt(localStorage.getItem(BEST_KEY) || '0', 10);
  const bestBox = document.getElementById('bestBox');
  if(best > 0) bestBox.innerHTML = `<div>Meilleur score local : <strong>${best}</strong></div>`;
  else bestBox.innerHTML = `<div>Aucun meilleur score enregistré.</div>`;
}

/* -------------------------
   Init
   ------------------------- */
initMap();
resetGame();
showBest();

// initial preview SV
(function initialPreview(){
  const p = choice(cityPoints.paris);
  setStreetView(p.lat, p.lng);
})();

/* allow Enter to validate */
document.addEventListener('keydown', (e)=> { if(e.key === 'Enter') submitGuess(false); });

// enable confirm button after map click
map && map.on && map.on('click', ()=> { document.getElementById('confirmBtn').disabled = false });
</script>
</body>
</html>







